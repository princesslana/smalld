build: &build
  steps:
    - checkout
    - run: |
        echo 'export SMALLD_VERSION="$(git describe --dirty --tags)-SNAPSHOT"' >> $BASH_ENV
        echo 'export MAVEN_OPTS="-Drevision=$SMALLD_VERSION -Dproperty=revision -DnewVersion=$SMALLD_VERSION -DgenerateBackupPoms=false"' >> $BASH_ENV
    - restore_cache:
        key: smalld-{{ checksum "pom.xml" }}
    - run: mvn -B verify

version: 2
jobs:
  dependency_cache:
    docker:
      - image: maven:3-jdk-8
    steps:
      - checkout
      - restore_cache:
          key: smalld-{{ checksum "pom.xml" }}
      - run: mvn -B dependency:go-offline
      - save_cache:
          paths:
          - ~/.m2
          key: smalld-{{ checksum "pom.xml" }}
  java8:
    docker:
      - image: maven:3-jdk-8
    steps:
      - checkout
      - run: |
          echo 'export SMALLD_VERSION="$(git describe --dirty --tags)-SNAPSHOT"' >> $BASH_ENV
          echo 'export MAVEN_OPTS="-Drevision=$SMALLD_VERSION -Dproperty=revision -DnewVersion=$SMALLD_VERSION -DgenerateBackupPoms=false"' >> $BASH_ENV
      - restore_cache:
          key: smalld-{{ checksum "pom.xml" }}
      - run: mvn -B verify
      - persist_to_workspace:
          root: .
          paths: .
  java11:
    <<: *build
    docker:
      - image: maven:3-jdk-11
  java12:
    <<: *build
    docker:
      - image: maven:3-jdk-12
  corretto8:
    <<: *build
    docker:
      - image: maven:3-amazoncorretto-8
  corretto11:
    <<: *build
    docker:
      - image: maven:3-amazoncorretto-11

workflows:
  version: 2
  build:
    jobs:
      - dependency_cache:
          filters:
            tags:
              only: /.*/
      - java8:
          requires:
            - dependency_cache
          filters:
            tags:
              only: /.*/
      - java11:
          requires:
            - dependency_cache
          filters:
            tags:
              only: /.*/
      - java12:
          requires:
            - dependency_cache
          filters:
            tags:
              only: /.*/
      - corretto8:
          requires:
            - dependency_cache
          filters:
            tags:
              only: /.*/
      - corretto11:
          requires:
            - dependency_cache
          filters:
            tags:
              only: /.*/
